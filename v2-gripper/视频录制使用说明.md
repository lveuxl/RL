# 训练视频录制功能使用说明

## 概述

本功能为训练脚本 `training.py` 添加了强大的视频录制能力，让您能够在训练过程中自动录制高质量的视频。

## 功能特性

### 🎬 核心功能
- **自动视频录制**: 训练过程中自动录制指定episode的视频
- **高质量输出**: 支持高分辨率、高帧率视频录制
- **智能触发**: 可配置录制间隔，避免录制所有episode
- **信息叠加**: 在视频上显示奖励、动作等训练信息
- **流畅渲染**: 启用子步渲染，确保视频流畅度

### 📊 技术特性
- **RGB模式**: 自动切换到RGB观测模式以支持视频录制
- **向量化兼容**: 完全兼容ManiSkill的向量化环境
- **物体稳定**: 录制前自动等待物体稳定，确保视频质量
- **轨迹保存**: 可选保存完整的状态轨迹数据

## 使用方法

### 基础用法

```bash
# 启用视频录制（使用默认参数）
python training.py --record_video

```

### 高级配置

```bash
# 自定义视频质量和录制间隔
python training.py --record_video \
    --video_width 512 \
    --video_height 512 \
    --video_fps 60 \
    --video_record_interval 10 \
    --max_video_steps 1500

# 快速测试配置（低质量，频繁录制）
python training.py --record_video \
    --video_width 128 \
    --video_height 128 \
    --video_fps 15 \
    --video_record_interval 1 \
    --max_video_steps 200
```

## 参数详解

### 视频录制参数

| 参数名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `--record_video` | flag | False | 启用视频录制 |
| `--save_trajectory` | flag | False | 保存轨迹数据 |
| `--video_record_interval` | int | 50 | 录制间隔（每N个episode录制一次） |
| `--max_video_steps` | int | 1000 | 每个视频的最大步数 |
| `--video_fps` | int | 30 | 视频帧率 |
| `--video_width` | int | 256 | 视频宽度 |
| `--video_height` | int | 256 | 视频高度 |
| `--settle_steps` | int | 30 | 物体稳定等待步数 |

### 预设配置

#### 🎥 高质量配置（适合演示）
```bash
python training.py --record_video \
    --video_width 512 \
    --video_height 512 \
    --video_fps 60 \
    --video_record_interval 100 \
    --max_video_steps 2000
```

#### ⚡ 快速配置（适合调试）
```bash
python training.py --record_video \
    --video_width 128 \
    --video_height 128 \
    --video_fps 15 \
    --video_record_interval 5 \
    --max_video_steps 500
```

#### 🎯 平衡配置（推荐）
```bash
python training.py --record_video \
    --video_width 256 \
    --video_height 256 \
    --video_fps 30 \
    --video_record_interval 20 \
    --max_video_steps 1000
```

## 输出文件

### 视频文件
- **位置**: `logs/env_clutter/training_videos/`
- **格式**: MP4
- **命名**: 自动时间戳命名
- **内容**: 包含动作信息、奖励值等叠加信息

### 轨迹文件（可选）
- **位置**: `logs/env_clutter/training_videos/`
- **格式**: H5/JSON
- **内容**: 完整的状态、动作、奖励序列

### 日志增强
- **CSV日志**: 新增 `video_recorded` 字段
- **TensorBoard**: 新增录制统计信息

## 工作原理

### 录制流程
1. **环境初始化**: 自动切换到RGB观测模式
2. **包装器应用**: 添加RecordEpisode和ManiSkillVectorEnv包装器
3. **触发检测**: 根据episode计数判断是否录制
4. **物体稳定**: 录制前等待物体自然稳定
5. **视频录制**: 高质量录制训练过程
6. **信息叠加**: 实时显示训练指标

### 技术实现
```python
# 关键代码片段
if args.record_video:
    # 1. 切换观测模式
    obs_mode="rgb"
    render_mode="rgb_array"
    
    # 2. 添加录制包装器
    env = RecordEpisode(
        env,
        output_dir=video_output_dir,
        save_video=True,
        video_fps=args.video_fps,
        render_substeps=True,
        info_on_video=True,
        save_video_trigger=video_trigger
    )
    
    # 3. 向量化包装
    env = ManiSkillVectorEnv(env, num_envs, record_metrics=True)
```

## 性能影响

### 计算开销
- **RGB渲染**: 增加约20-30%的计算时间
- **视频编码**: 每个录制episode增加5-10秒处理时间
- **内存使用**: 增加约500MB-1GB内存占用

### 优化建议
1. **调整录制间隔**: 不要录制每个episode，推荐间隔10-50
2. **合理设置分辨率**: 调试时使用128x128，演示时使用512x512
3. **限制视频长度**: 设置合理的`max_video_steps`避免超长视频

## 故障排除

### 常见问题

#### 问题1: 视频文件为空或损坏
**原因**: 环境渲染失败或编码问题
**解决方案**:
```bash
# 检查GPU内存是否充足
nvidia-smi

# 降低视频分辨率
python training.py --record_video --video_width 128 --video_height 128
```

#### 问题2: 录制频率过高导致磁盘空间不足
**原因**: `video_record_interval` 设置过小
**解决方案**:
```bash
# 增加录制间隔
python training.py --record_video --video_record_interval 100
```

#### 问题3: 训练速度大幅下降
**原因**: 视频录制开销过大
**解决方案**:
```bash
# 使用快速配置
python training.py --record_video \
    --video_width 128 \
    --video_height 128 \
    --video_fps 15 \
    --video_record_interval 50
```

## 测试验证

### 运行测试脚本
```bash
# 完整测试（包含训练）
python test_training_video.py

# 快速测试（仅参数验证）
python test_training_video.py --skip_training

# 测试后清理
python test_training_video.py --cleanup
```

### 手动验证
1. 启动录制训练: `python training.py --record_video`
2. 检查输出目录: `ls logs/env_clutter/training_videos/`
3. 播放视频文件: 使用任何视频播放器
4. 验证信息叠加: 确保视频中显示训练信息

## 与原始功能对比

| 特性 | test_ik_upgrade.py | training.py (新增) |
|------|-------------------|-------------------|
| 录制质量 | 高质量 (256x256, 60fps) | 可配置 (128-512, 15-60fps) |
| 录制时机 | 测试时 | 训练中智能触发 |
| 信息叠加 | 支持 | 支持 |
| 轨迹保存 | 支持 | 支持 |
| 向量化兼容 | 是 | 是 |
| 物体稳定 | 支持 | 支持 |
| 自动化程度 | 手动 | 全自动 |

## 最佳实践

### 🎯 推荐工作流程
1. **调试阶段**: 使用快速配置，频繁录制
2. **训练阶段**: 使用平衡配置，适中录制
3. **演示阶段**: 使用高质量配置，精选录制

### 📝 配置建议
- **开发环境**: 128x128, 15fps, interval=5
- **生产环境**: 256x256, 30fps, interval=50
- **演示环境**: 512x512, 60fps, interval=100

### 💾 存储管理
- 定期清理旧视频文件
- 使用外部存储设备保存重要视频
- 设置合理的磁盘空间阈值

## 结语

本视频录制功能完全仿照 `test_ik_upgrade.py` 的成熟实现，为训练过程提供了强大的可视化能力。通过合理配置参数，您可以在训练效率和视频质量之间找到最佳平衡点。

如有问题或建议，请查看代码注释或联系开发团队。 