<!-- Generated by SpecStory -->

# Explore Panda robot controllers (2026-02-25 12:46Z)

_**Assistant**_



---





---



---



---



---



---



---





---



---



---



---



---

<think><details><summary>Thought Process</summary>**Analyzing frame definitions**

I'm examining the default frame definition for pd_ee_delta_pose and its rotation representation in axis-angle format. I'm examining how root_translation and body_translation differ in the compute_target_pose function. </details></think>

---





---



---



---



---



---





---



---



---



---



---





---



---



---



---



---





---



---



---

<think><details><summary>Thought Process</summary>**Fixing ee_align frame**

I found that 'ee_align' frame lacks required translation/rotation components, causing undefined variables in compute_target_pose. 

**Identifying frame aliases**

I identified that 'ee_align' might be an alias for body-frame control and noted potential bugs in panda_stick's pd_ee_delta_pose_align. </details></think>

---





---



---



---



---


Verifying the docs' statement about axis-angle vs XYZ Euler and fetching the controller config path.


---



---



---



---


Here’s the report:

---

## Report: Panda Robot, Controllers, and pd_ee_delta_pose

### 1. Panda robot definition and files

- **Panda**: `/Users/jianzihang/Downloads/RL_Robot/agents/robots/panda/panda.py`  
  - Class: `Panda(BaseAgent)`  
  - UID: `"panda"`  
  - URDF: `{PACKAGE_ASSET_DIR}/robots/panda/panda_v2.urdf`  
  - EE link: `panda_hand_tcp`

- **Other Panda-related**: `panda_stick.py`, `panda_wristcam.py`, `floating_panda_gripper.py`

---

### 2. Controller modes for Panda

From `/Users/jianzihang/Downloads/RL_Robot/agents/robots/panda/panda.py` (185–214):

- `pd_joint_delta_pos`
- `pd_joint_pos`
- `pd_ee_delta_pos`
- `pd_ee_delta_pose`
- `pd_ee_pose`
- `pd_joint_target_delta_pos`
- `pd_ee_target_delta_pos`
- `pd_ee_target_delta_pose`
- `pd_joint_vel`
- `pd_joint_pos_vel`
- `pd_joint_delta_pos_vel`

---

### 3. PD EE controller implementation and delta frame

**Implementation**: `/Users/jianzihang/Downloads/RL_Robot/agents/controllers/pd_ee_pose.py`  
- `PDEEPoseController` (around lines 197–265)  
- Target pose computation: `compute_target_pose` (around 239–265)

**Delta frame (default `"root_translation:root_aligned_body_rotation"`):**

```239:254:agents/controllers/pd_ee_pose.py
    def compute_target_pose(self, prev_ee_pose_at_base: Pose, action):
        if self.config.use_delta:
            delta_pos, delta_rot = action[:, 0:3], action[:, 3:6]
            delta_quat = matrix_to_quaternion(euler_angles_to_matrix(delta_rot, "XYZ"))
            delta_pose = Pose.create_from_pq(delta_pos, delta_quat)
            if "root_aligned_body_rotation" in self.config.frame:
                q = quaternion_multiply(delta_pose.q, prev_ee_pose_at_base.q)
            if "body_aligned_body_rotation" in self.config.frame:
                q = quaternion_multiply(prev_ee_pose_at_base.q, delta_pose.q)
            if "root_translation" in self.config.frame:
                p = prev_ee_pose_at_base.p + delta_pos
            if "body_translation" in self.config.frame:
                p = prev_ee_pose_at_base.p + quaternion_apply(
                    prev_ee_pose_at_base.q, delta_pose.p
                )
```

- **Default**: `"root_translation:root_aligned_body_rotation"`
- **Translation**  
  - `root_translation`: `p = prev_ee_pose_at_base.p + delta_pos` → delta in **root/base frame (world)**  
  - `body_translation`: `p = prev_ee_pose_at_base.p + quaternion_apply(prev_ee_pose_at_base.q, delta_pose.p)` → delta in **EE frame**
- **Rotation**  
  - `root_aligned_body_rotation`: `q = delta_q * prev_q` → rotation expressed in root frame  
  - `body_aligned_body_rotation`: `q = prev_q * delta_q` → rotation in EE frame

So for the default config, both translation and rotation are in the **root/base (world) frame**, **not** the EE frame.

---

### 4. panda_stick robot

- **Definition**: `/Users/jianzihang/Downloads/RL_Robot/agents/robots/panda/panda_stick.py`  
  - Class: `PandaStick(BaseAgent)`  
  - UID: `"panda_stick"`  
  - URDF: `panda_stick.urdf`  
  - Same EE link: `panda_hand_tcp`  
  - No gripper joints (7 DoF arm only)

**Controller modes** (146–161):

- `pd_joint_delta_pos`, `pd_joint_pos`, `pd_ee_delta_pos`, `pd_ee_delta_pose`, `pd_ee_delta_pose_align`, `pd_ee_pose`, `pd_joint_target_delta_pos`, `pd_ee_target_delta_pos`, `pd_ee_target_delta_pose`, `pd_joint_vel`, `pd_joint_pos_vel`, `pd_joint_delta_pos_vel`

**pd_ee_delta_pose_align**: same as `pd_ee_delta_pose` but with `frame = "ee_align"`. The PD EE controller does not handle `"ee_align"` explicitly; it expects one of the frame strings with `root_translation` / `body_translation` and `root_aligned_body_rotation` / `body_aligned_body_rotation`. Use of `"ee_align"` could therefore be buggy or nonstandard.

---

### 5. Action space for pd_ee_delta_pose

**From `/Users/jianzihang/Downloads/RL_Robot/agents/controllers/pd_ee_pose.py`** (205–222):

- **Arm (pd_ee_delta_pose)**  
  - Dimension: 6  
  - Elements:  
    - 0–2: position delta (x, y, z), in meters  
    - 3–5: rotation delta as XYZ Euler angles, in radians  
  - Bounds: `pos_lower/pos_upper = -0.1 / 0.1`, `rot_lower/rot_upper = -0.1 / 0.1`  
  - With `normalize_action=True` (default), action space is normalized to [-1, 1].

**Panda (with gripper):**

- Arm: 6 (position delta + rotation delta)  
- Gripper: 1 (gripper mimic joint)  
- Total action dim: **7**

**Panda_stick (no gripper):**

- Arm only: **6**

---

### 6. Controller config location

- **Panda**:  
  `/Users/jianzihang/Downloads/RL_Robot/agents/robots/panda/panda.py`  
  - Config property: `_controller_configs` (around 75–216)  
  - `pd_ee_delta_pose` entry at lines 191–194:

```191:194:agents/robots/panda/panda.py
            pd_ee_delta_pose=dict(
                arm=arm_pd_ee_delta_pose, gripper=gripper_pd_joint_pos
            ),
```

- **Panda_stick**:  
  `/Users/jianzihang/Downloads/RL_Robot/agents/robots/panda/panda_stick.py`  
  - Config property: `_controller_configs` (around 47–165)  
  - `pd_ee_delta_pose` entry at lines 150–151:

```150:151:agents/robots/panda/panda_stick.py
            pd_ee_delta_pose=dict(arm=arm_pd_ee_delta_pose),
```

---

### Summary

| Item | Answer |
|------|--------|
| **Panda controller modes** | `pd_joint_delta_pos`, `pd_joint_pos`, `pd_ee_delta_pos`, `pd_ee_delta_pose`, `pd_ee_pose`, `pd_joint_target_delta_pos`, `pd_ee_target_delta_pos`, `pd_ee_target_delta_pose`, `pd_joint_vel`, `pd_joint_pos_vel`, `pd_joint_delta_pos_vel` |
| **pd_ee_delta_pose action dim** | 7 (Panda): arm 6 + gripper 1. 6 for Panda_stick. |
| **Element meaning** | [0–2]: x,y,z delta (m), [3–5]: XYZ Euler rotation (rad). Gripper: joint position for mimic gripper. |
| **Delta frame** | Default: **root/base (world)**, not EE frame. Both translation and rotation are in root frame. |
| **panda_stick exists?** | Yes. `/Users/jianzihang/Downloads/RL_Robot/agents/robots/panda/panda_stick.py` |
| **panda_stick action format** | pd_ee_delta_pose: 6 dim (arm only, no gripper). |
| **Controller config path** | Panda: `agents/robots/panda/panda.py` (`_controller_configs`). Panda_stick: `agents/robots/panda/panda_stick.py` (`_controller_configs`). |

---

