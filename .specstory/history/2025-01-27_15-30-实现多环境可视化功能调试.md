# 实现多环境可视化功能调试 (2025-01-27 15:30)

## 问题描述

用户希望在ManiSkill PPO训练过程中实现多环境可视化功能，能够在一个界面中同时显示所有并行环境的训练状态。但在SSH环境中遇到了可视化界面无法显示的问题。

## 解决方案实施过程

### 1. 添加命令行参数支持

首先发现训练脚本缺少必要的命令行参数，添加了以下参数：

```python
# 添加训练配置参数
parser.add_argument('--num_envs', type=int, default=8,
                   help='并行环境数量')
parser.add_argument('--total_timesteps', type=int, default=50000,
                   help='总训练步数')
parser.add_argument('--enable_render', action='store_true',
                   help='启用可视化渲染')
parser.add_argument('--render_freq', type=int, default=100,
                   help='渲染频率（每N步渲染一次）')
parser.add_argument('--learning_rate', type=float, default=3e-4,
                   help='学习率')
parser.add_argument('--batch_size', type=int, default=64,
                   help='批次大小')
parser.add_argument('--n_steps', type=int, default=2048,
                   help='每个环境的步数')
```

### 2. 实现多环境可视化回调

创建了 `MultiEnvVisualizationCallback` 类来处理多环境的可视化：

```python
class MultiEnvVisualizationCallback(BaseCallback):
    """多环境可视化回调 - 在SSH环境中保存可视化图像"""
    
    def __init__(self, render_freq=10, verbose=0):
        super().__init__(verbose)
        self.render_freq = render_freq
        self.step_count = 0
        self.save_dir = "visualization_images"
        
        # 创建保存目录
        os.makedirs(self.save_dir, exist_ok=True)
```

### 3. 适配SSH环境的可视化方案

由于SSH环境无法直接显示图形界面，将原本的 `cv2.imshow()` 改为保存图像文件的方式：

```python
def _save_multi_env_image(self, images):
    """保存多环境组合图像到文件"""
    try:
        num_envs = len(images)
        if num_envs == 0:
            return
        
        # 计算网格布局
        cols = int(np.ceil(np.sqrt(num_envs)))
        rows = int(np.ceil(num_envs / cols))
        
        # 获取单个图像的尺寸
        h, w = images[0].shape[:2]
        
        # 创建组合图像
        combined_img = np.zeros((rows * h, cols * w, 3), dtype=np.uint8)
        
        # 填充图像并添加环境编号标签
        for i, img in enumerate(images):
            row = i // cols
            col = i % cols
            
            # 确保图像尺寸一致
            if img.shape[:2] != (h, w):
                img = cv2.resize(img, (w, h))
            
            # 放置图像
            combined_img[row*h:(row+1)*h, col*w:(col+1)*w] = img
            
            # 添加环境编号标签
            cv2.putText(combined_img, f'Env {i}', 
                       (col*w + 10, row*h + 30), 
                       cv2.FONT_HERSHEY_SIMPLEX, 0.7, (255, 255, 255), 2)
        
        # 保存组合图像
        filename = f"{self.save_dir}/multi_env_step_{self.step_count:06d}.png"
        cv2.imwrite(filename, combined_img)
        
        # 保持最新的10张图像，删除旧的
        import glob
        all_images = sorted(glob.glob(f"{self.save_dir}/multi_env_step_*.png"))
        if len(all_images) > 10:
            for old_img in all_images[:-10]:
                try:
                    os.remove(old_img)
                except:
                    pass
        
    except Exception as e:
        if self.verbose > 0:
            print(f"保存组合图像失败: {e}")
```

### 4. 集成到训练流程

在训练函数中集成多环境可视化回调：

```python
# 如果启用可视化，添加多环境可视化回调
if config.enable_render:
    multi_env_viz_callback = MultiEnvVisualizationCallback(
        render_freq=config.render_freq, 
        verbose=1
    )
    callbacks.append(multi_env_viz_callback)
    print(f"已启用多环境可视化 - 将在一个窗口中显示所有 {config.num_envs} 个环境")
```

## 当前状态

### 已完成功能
1. ✅ 添加了完整的命令行参数支持
2. ✅ 实现了多环境可视化回调类
3. ✅ 适配SSH环境，使用图像文件保存方式
4. ✅ 集成到训练流程中
5. ✅ 添加了图像文件管理（保持最新10张图像）

### 发现的问题
1. 🔍 多环境可视化图像文件没有正确生成
2. 🔍 回调可能没有被正确触发
3. 🔍 需要进一步调试回调的执行状态

### 验证结果
- 训练脚本能够正确解析命令行参数
- 创建了 `visualization_images` 目录
- 生成了一些可视化图像文件，但不是多环境组合的格式

## 使用方法

```bash
# 启动多环境可视化训练
conda activate /home2/jzh/anaconda3/envs/maniskill
python ppo_maniskill_training.py --num_envs 4 --total_timesteps 10000 --enable_render --render_freq 50
```

## 后续改进方向

1. **调试回调触发问题**：检查为什么多环境可视化回调没有正确执行
2. **添加调试输出**：增加更多的日志输出来跟踪回调的执行状态
3. **创建测试脚本**：开发独立的测试脚本来验证多环境可视化功能
4. **优化图像布局**：改进多环境图像的组合布局和标签显示
5. **添加实时监控**：考虑添加训练进度和性能指标的可视化

## 技术要点

- **SSH环境适配**：使用文件保存替代直接显示，解决远程环境的可视化问题
- **多环境布局**：采用网格布局自动计算最佳的行列组合
- **资源管理**：自动清理旧的图像文件，避免磁盘空间占用过多
- **错误处理**：添加了完善的异常处理机制，确保单个环境渲染失败不影响整体训练

## 相关文件

- `ppo_maniskill_training.py` - 主训练脚本，包含多环境可视化回调
- `stack_picking_maniskill_env.py` - 自定义ManiSkill环境
- `visualization_images/` - 可视化图像保存目录 