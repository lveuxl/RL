<!-- Generated by SpecStory -->

# 修复物体状态观测和遮挡检测问题 (2025-08-31 09:55Z)

_**User**_

修复以下问题：1.理想化神谕模式中物体“瞬移”可能影响状态观测
在 _ideal_oracle_fsm 中：
self.oracle_attached_object[env_idx].set_pose(far_pose)  # 瞬移到 (10,10,10)
问题：如果状态观测中包含所有物体的位置（如 obs["object_positions"]），这些“已抓取但未删除”的物体会出现在远处，干扰策略判断。
✅ 建议：
在 obs 中只提供当前可抓取物体的信息。
将已抓取物体从 selectable_objects 中移除，并在 obs 中不暴露其位置。2.遮挡检测 _is_object_blocked 过于简化
# 用 xy 距离和 z 高度差判断是否被压住
if xy_distance < 0.08 and z_distance < 0.03:
    return True
问题：依赖固定阈值，对不同大小物体不鲁棒（如大盒子压小盒子可能距离 >8cm）。
✅ 建议：
改为基于物体 bounding box 的碰撞检测（可用 sapien 的 AABB 或 OBB 包络）。
或使用射线检测：从物体顶部向下发射射线，看是否击中其他物体。注意修改的时候参照官方控制文件，不要自己杜撰函数和功能，使用正确的函数修改，只创建一个测试文件测试

---

_**Assistant**_

<think><details><summary>Thought Process</summary>根据用户的需求，我需要修复两个主要问题：

1. 理想化神谕模式中物体"瞬移"可能影响状态观测的问题
2. 遮挡检测过于简化的问题

首先，让我分析一下代码：

1. **瞬移问题**：在 `_ideal_oracle_fsm` 的 stage 4 中，物体会被瞬移到 (10, 10, 10) 位置，但如果观测中包含这些物体的位置信息，会干扰策略判断。需要确保已抓取的物体从可选对象列表中移除，并且在观测中不暴露其位置。

2. **遮挡检测问题**：`_is_object_blocked` 方法使用固定阈值（xy距离<5cm，z高度差），对不同大小的物体不够鲁棒。需要改进为基于物体包围盒的检测或射线检测。

让我查看代码中的关键部分：

从 `_ideal_oracle_fsm` 的 stage 4 可以看到：
```python
elif stage == 4:
    # Stage 4: 瞬移物体到远处（不张开夹爪）
    if tick == 0:
        print(f"环境{env_idx}: Stage 4 - 瞬移物体到远处")
        
        if self.oracle_attached_object[env_idx] is not None:
            try:
                # 瞬移到远处（例如 (10, 10, 10)）
                far_pose = sapien.Pose(p=[10.0, 10.0, 10.0])
                self.oracle_attached_object[env_idx].set_pose(far_pose)
                print(f"环境{env_idx}: ✅ 物体已瞬移到远处")
                
                # 断开理想化连接
                self.oracle_attached_object[env_idx] = None
            except Exception as e:
                print(f"环境{env_idx}: 瞬移物体失败: {e}")
```

瞬移后，我需要确保从 `selectable_objects` 中移除该物体，并在观测中隐藏其位置信息。这样可以防止策略被错误的位置信息干扰。

在 `_get_obs_extra` 方法中，当前代码会获取所有环境中的可选物体，包括已经被移除的对象。我需要修改这个逻辑，确保只返回有效的、未被瞬移的物体。对于遮挡检测方法，也需要相应地更新处理逻辑。

遮挡检测的实现需要考</details></think>

---

